<?php
function msg_moderation_menu() {
    $items = array();
    $items['admin/structure/msg_moderation'] = array(
        'title' => t('Message moderation'),
        'description' => t('List of messages for moderation'),
        'page callback' => 'drupal_get_form',
        'page arguments' => array('msg_moderation_form'),
        'access arguments' => array('administer site configuration'),
    );
    return $items;
}

function msg_moderation_form($form_state) {

    $header = array
    (
        'author' => t('Author'),
        'message' => t('Message'),
    );
    $list = get_moderated_messages();
    if(!$list){
        $form['table'] = array
        (
            '#type' => 'tableselect',
            '#header' => $header,
            '#empty' => t('All messages was moderated'),
        );
        return $form;
    }
    $options = array();
    foreach($list as $message)
    {
        $message['body'] = t('Sender').": ".$message['name']
//            ."\n".t("Mobile phone").": ".$message['m_phone']
//            ."\n".t("Home phone").": ".$message['h_phone']
//            ."\n".t("E-mail").": ".$message['email']
            ."\n".t("Question").": ".$message['question'];
        if($message['file'] != ''){
            $file = unserialize($message['file']);
            $file_url = file_create_url($file->uri);
            $message['body'] .="\n".t("File").": ".l($file->filename, $file_url);
        }
        $options[$message['id']] = array
        (
            'author' => ($message['author_name'] != '') ? $message['author_name'] : t('Guest'),
            'message' => mat_moderation($message['body']),
        );
    }

    $form['table'] = array
    (
        '#type' => 'tableselect',
        '#header' => $header,
        '#options' => $options,
        '#empty' => t('Messages not found'),
    );
    $form['pager'] = array('#markup' => theme('pager'));

    $form['action'] = array(
        '#type' => 'select',
        '#title' => t('The action with the selected fields'),
        '#options' => array(
            0 => t('Confirm'),
            1 => t('Reject'),
        ),
        '#default_value' => 0,
    );
    $form['submit'] = array(
        '#type' => 'submit',
        '#value' => t('Save'),
    );

    return $form;

}

function msg_moderation_form_submit($form, &$form_state) {
    foreach($form['table'] as $messages){
        if(isset($messages['#checked']) and $messages['#checked'] == true){
            $selected[] = $messages['#return_value'];
        }
    }
    if(isset($selected)){
        if($form['action']['#value'] == 0){
            $conf_messages = get_confirm_msg($selected);
            foreach($conf_messages as $message){
                $users = unserialize($message['users']);
                $message['body'] = t('Sender').": ".$message['name']
//                    ."\n".t("Mobile phone").": ".$message['m_phone']
//                    ."\n".t("Home phone").": ".$message['h_phone']
//                    ."\n".t("E-mail").": ".$message['email']
                    ."\n".t("Question").": ".$message['question'];
                if($message['file'] != ''){
                    $file = unserialize($message['file']);
                    $file_url = file_create_url($file->uri);
                    $message['body'] .="\n".t("File").": ".l($file->filename, $file_url);
                }
                $author = user_load($message['author_id']);
                foreach($users as $uid){
                    $new_message = privatemsg_new_thread(array(user_load($uid)), t('Theme'), $message['body'], array('author' => $author, 'new' => true));
                    $array_mid[] = array('mid' => $new_message['message']->mid, 'email' => $message['email'], 'm_phone' => $message['m_phone'], 'h_phone' => $message['h_phone']);
                }
                guest_reply_insert($array_mid);
            }
            update($selected, '1');
        }else{
            update($selected, '2');
        }
    }
}
function guest_reply_insert($array_mid){
    $query = db_insert('guest_reply')->fields(array('mid', 'email', 'm_phone', 'h_phone'));
    foreach ($array_mid as $array) {
        $query->values($array);
    }
    $query->execute();
}
function get_confirm_msg($selected){
    $query = db_select('catalog_msg', 'cm')
        ->fields('cm')
        ->condition('id', $selected, 'IN')
        ->execute();
    while ($message = $query->fetchassoc()){
        $messages[] = $message;
    }
    return $messages;
}

function update($update, $status){
    db_update('catalog_msg')
        ->fields(array('status' => $status,))
        ->condition ('id', $update, 'IN')
        ->execute();
}

function mat_moderation($input){
    $pattern = "/\w{0,5}[хx]([хx\s\!@#\$%\^&*+-\|\/]{0,6})[уy]([уy\s\!@#\$%\^&*+-\|\/]{0,6})[ёiлeеюийя]\w{0,7}|\w{0,6}[пp]([пp\s\!@#\$%\^&*+-\|\/]{0,6})[iие]([iие\s\!@#\$%\^&*+-\|\/]{0,6})[3зс]([3зс\s\!@#\$%\^&*+-\|\/]{0,6})[дd]\w{0,10}|[сcs][уy]([уy\!@#\$%\^&*+-\|\/]{0,6})[4чkк]\w{1,3}|\w{0,4}[bб]([bб\s\!@#\$%\^&*+-\|\/]{0,6})[lл]([lл\s\!@#\$%\^&*+-\|\/]{0,6})[yя]\w{0,10}|\w{0,8}[её][bб][лске@eыиаa][наи@йвл]\w{0,8}|\w{0,4}[еe]([еe\s\!@#\$%\^&*+-\|\/]{0,6})[бb]([бb\s\!@#\$%\^&*+-\|\/]{0,6})[uу]([uу\s\!@#\$%\^&*+-\|\/]{0,6})[н4ч]\w{0,4}|\w{0,4}[еeё]([еeё\s\!@#\$%\^&*+-\|\/]{0,6})[бb]([бb\s\!@#\$%\^&*+-\|\/]{0,6})[нn]([нn\s\!@#\$%\^&*+-\|\/]{0,6})[уy]\w{0,4}|\w{0,4}[еe]([еe\s\!@#\$%\^&*+-\|\/]{0,6})[бb]([бb\s\!@#\$%\^&*+-\|\/]{0,6})[оoаa@]([оoаa@\s\!@#\$%\^&*+-\|\/]{0,6})[тnнt]\w{0,4}|\w{0,10}[ё]([ё\!@#\$%\^&*+-\|\/]{0,6})[б]\w{0,6}|\w{0,4}[pп]([pп\s\!@#\$%\^&*+-\|\/]{0,6})[иeеi]([иeеi\s\!@#\$%\^&*+-\|\/]{0,6})[дd]([дd\s\!@#\$%\^&*+-\|\/]{0,6})[oоаa@еeиi]([oоаa@еeиi\s\!@#\$%\^&*+-\|\/]{0,6})[рr]\w{0,12}/u";
    return preg_replace($pattern, t('[censor]'), $input);
}

function msg_moderation_privatemsg_message_presave_alter(&$message) {
    if($message->author->uid != '1'){
        if(!isset($message->new)){
            $message->subject = mat_moderation($message->subject);
            $message->body = mat_moderation($message->body);
        }
    }
}

function get_moderated_messages(){
    $query = db_select('catalog_msg', 'cm')
        ->extend('PagerDefault');
    $query->innerJoin('users', 'u', 'u.uid = cm.author_id');
    $query->fields('cm');
    $query->addField('u', 'name', 'author_name');
    $query->condition('cm.status', '0', '=');
    $result = $query->limit(20)
        ->execute();
    while ($message = $result->fetchassoc()){
        $messages[] = $message;
    }
    return isset($messages) ? $messages : '';

}
